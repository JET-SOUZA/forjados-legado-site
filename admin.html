<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerar Index de Fotos ‚Äî Forjados Legado</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #0f1720;
      color: #fff;
      max-width: 720px;
      margin: auto;
    }
    h1 {
      text-align: center;
      background: linear-gradient(90deg, #ff2c00, #ff6a00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    button {
      background: linear-gradient(90deg, #ff6a00, #ff2c00);
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      display: block;
      margin: 20px auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    #log {
      background: rgba(255,255,255,0.08);
      padding: 14px;
      border-radius: 10px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 480px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>üß† Gerar Index de Fotos do Evento</h1>
  <p>Esse painel analisa todas as fotos listadas em <code>fotos.json</code>, detecta rostos e cria o arquivo <code>event-index.json</code> para ser usado na galeria.</p>

  <button id="start">Gerar Index</button>
  <div id="log"></div>

  <script>
    const log = msg => {
      const logEl = document.getElementById('log');
      logEl.textContent += msg + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    };

    document.getElementById('start').onclick = async () => {
      log('üß© Carregando modelos de reconhecimento...');
      await faceapi.nets.tinyFaceDetector.loadFromUri('./Forjados/Forjados/models');
      await faceapi.nets.faceLandmark68Net.loadFromUri('./Forjados/Forjados/models');
      await faceapi.nets.faceRecognitionNet.loadFromUri('./Forjados/Forjados/models');
      log('‚úÖ Modelos carregados.');

      log('üìÅ Carregando fotos.json...');
      const res = await fetch('./fotos.json');
      const fotos = await res.json();
      log(`üîç ${fotos.length} fotos encontradas.`);

      const resultados = [];
      const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.5 });

      for (const [i, foto] of fotos.entries()) {
        log(`\nüñºÔ∏è [${i + 1}/${fotos.length}] Processando: ${foto.alt}`);
        try {
          const img = await faceapi.fetchImage(foto.src);
          const detection = await faceapi
            .detectSingleFace(img, options)
            .withFaceLandmarks()
            .withFaceDescriptor();

          if (detection) {
            resultados.push({
              nome: foto.alt,
              url: foto.src,
              descriptor: Array.from(detection.descriptor)
            });
            log(' ‚Üí Rosto detectado ‚úÖ');
          } else {
            log(' ‚Üí Nenhum rosto detectado ‚ö†Ô∏è');
          }
        } catch (e) {
          log(`‚ùå Erro na imagem ${foto.alt}: ${e.message}`);
        }
      }

      // Criar download do event-index.json
      const blob = new Blob([JSON.stringify(resultados, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'event-index.json';
      link.textContent = 'üíæ Baixar event-index.json';
      link.style.display = 'block';
      link.style.marginTop = '20px';
      document.body.appendChild(link);

      log('\n‚úÖ Processamento finalizado. Clique no link acima para baixar o event-index.json.');
    };
  </script>
</body>
</html>
